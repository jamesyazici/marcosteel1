<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Carousel</title>
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
    rel="stylesheet">
  <script 
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
  </script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: transparent; /* so iframe background is transparent */
    }
    .carousel-container {
      margin-left: 5%;
      width: 90%;
      box-sizing: border-box;
      padding: 7px 7px 0px 7px;
      background-color:#eeeeee;
      border-top:2px solid gray;
      border-left:2px solid gray;
      border-right:2px solid gray;
    }
    .carousel-controls-container {
      background-color:#46606a;
      display:flex;
      margin-left:5%;
      width:90%;
      height:30px;
    }
    .carousel-prev, .carousel-next {
      display:flex;
      align-items:center;
      justify-content: center;
      flex:1;
    }
    .cbutton {
      margin: 0 5px;
      background-color:#46606a;
      border:none;
      font-weight:bolder;
      color:white;
    }
  </style>
</head>
<body>
  <!-- ADDED WRAPPER BELOW -->
  <div id="wrap">
    <div id="myCarousel" class="carousel slide carousel-container">
      <!-- <div class="carousel-inner">
        <div class="carousel-item active">
          <img src="camera.png" class="d-block w-100" alt="Slide 1">
        </div>
        <div class="carousel-item">
          <img src="computer.png" class="d-block w-100" alt="Slide 2">
        </div>
      </div> -->
      <div class="carousel-inner" id="carouselInner"></div>
    </div>
    <div class="carousel-controls-container">
      <div class="carousel-prev">
        <button class="cbutton" type="button" data-bs-target="#myCarousel" data-bs-slide="prev" style="display:flex;justify-content:left;">
          &lt; back
        </button>
      </div>
      <div class="carousel-next">
        <button class="cbutton" type="button" data-bs-target="#myCarousel" data-bs-slide="next" style="justify-content:right;">
          next >
        </button>
      </div>
    </div>
  </div>
  <!-- END ADDED WRAPPER -->

  <script>
    (function () {
      const wrap = document.getElementById('wrap');
      const car  = document.getElementById('myCarousel');

      function measure() {
        // Use layout height of the wrapper, not scrollHeight
        return Math.ceil(wrap.getBoundingClientRect().height);
      }

      function send() {
        parent.postMessage({ type: 'carouselHeight', height: measure() }, '*');
      }

      // A robust “burst” that catches async layout/transition frames
      function sendBurst() {
        send();
        requestAnimationFrame(send);
        setTimeout(send, 120);
        setTimeout(send, 300);
      }

      // Initial + viewport changes
      window.addEventListener('load', sendBurst);
      window.addEventListener('resize', sendBurst);

      // Observe content size (works on shrink + grow)
      new ResizeObserver(sendBurst).observe(wrap);

      // When slides change (before & after)
      car.addEventListener('slide.bs.carousel', sendBurst);
      car.addEventListener('slid.bs.carousel',  sendBurst);

      // When images finish loading (critical for shrink back down)
      document.querySelectorAll('img').forEach(img => {
        if (!img.complete) img.addEventListener('load', sendBurst, { once: true });
      });
    })();
    (async function () {
      const params = new URLSearchParams(window.location.search);
      const slug = params.get("slug");

      const inner = document.getElementById("carouselInner");
      const wrap = document.getElementById("wrap");
      const car  = document.getElementById("myCarousel");

      function sendHeight() {
        const h = Math.ceil(wrap.getBoundingClientRect().height);
        parent.postMessage({ type: "carouselHeight", height: h }, "*");
      }

      function sendBurst() {
        sendHeight();
        requestAnimationFrame(sendHeight);
        setTimeout(sendHeight, 120);
        setTimeout(sendHeight, 300);
      }

      if (!slug) {
        inner.innerHTML = `<div style="padding:10px;color:#666;">Missing slug</div>`;
        sendBurst();
        return;
      }

      let projects = [];
      try {
        const res = await fetch(`/api/projects`, { cache: "no-store" });
        const json = await res.json();
        projects = Array.isArray(json.data) ? json.data : [];
      } catch {
        inner.innerHTML = `<div style="padding:10px;color:#666;">Failed to load projects</div>`;
        sendBurst();
        return;
      }

      const project = projects.find(p => p.slug === slug);
      const images = (project && Array.isArray(project.carousel)) ? project.carousel : [];

      if (!images.length) {
        inner.innerHTML = `<div style="padding:10px;color:#666;">No carousel images</div>`;
        sendBurst();
        return;
      }

      inner.innerHTML = images.map((src, idx) => `
        <div class="carousel-item ${idx === 0 ? "active" : ""}">
          <img src="${src}" class="d-block w-100" alt="Slide ${idx + 1}">
        </div>
      `).join("");

      // Re-measure after images load
      document.querySelectorAll("img").forEach(img => {
        if (!img.complete) img.addEventListener("load", sendBurst, { once: true });
      });

      // Bootstrap slide events
      car.addEventListener("slide.bs.carousel", sendBurst);
      car.addEventListener("slid.bs.carousel",  sendBurst);

      // initial measure
      sendBurst();
      window.addEventListener("resize", sendBurst);
      new ResizeObserver(sendBurst).observe(wrap);
    })();
  </script>
</body>
</html>
